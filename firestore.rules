rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Players collection
    match /players/{playerId} {
      // Users can read all players (public data)
      allow read: if isAuthenticated();
      // Users can only create their own player document
      allow create: if isAuthenticated() && request.auth.uid == playerId && 
                       request.resource.data.createdBy == request.auth.uid;
      // Users can only update their own player document
      allow update: if isAuthenticated() && request.auth.uid == playerId;
      // Users can only delete their own player document
      allow delete: if isAuthenticated() && request.auth.uid == playerId;
    }
    
    // Teams collection
    match /teams/{teamId} {
      // All authenticated users can read teams (public data)
      allow read: if isAuthenticated();
      // Only authenticated users can create teams
      allow create: if isAuthenticated() && 
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.createdAt != null;
      // Only team admin (createdBy) can update teams
      allow update: if isAuthenticated() && 
                       resource.data.createdBy == request.auth.uid;
      // Only team admin can delete teams
      allow delete: if isAuthenticated() && 
                       resource.data.createdBy == request.auth.uid;
    }
    
    // Matches collection
    match /matches/{matchId} {
      // All authenticated users can read matches (public data)
      allow read: if isAuthenticated();
      // Only authenticated users can create matches
      allow create: if isAuthenticated() && 
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.createdAt != null;
      // Only match creator or team admins can update matches
      allow update: if isAuthenticated() && (
                       resource.data.createdBy == request.auth.uid ||
                       // Allow team admins to update match status and scores
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'scoreA', 'scoreB']))
                     );
      // Only match creator can delete matches
      allow delete: if isAuthenticated() && 
                       resource.data.createdBy == request.auth.uid;
    }
    
    // Match requests collection
    match /match_requests/{requestId} {
      // Users can read requests for their teams
      allow read: if isAuthenticated() && (
                     resource.data.sendingTeamId in get(/databases/$(database)/documents/teams/$(resource.data.sendingTeamId)).data.memberIds ||
                     resource.data.receivingTeamId in get(/databases/$(database)/documents/teams/$(resource.data.receivingTeamId)).data.memberIds
                   );
      // Authenticated users can create match requests
      allow create: if isAuthenticated() && 
                       request.resource.data.requestedBy == request.auth.uid &&
                       request.resource.data.createdAt != null;
      // Users can update requests for their teams
      allow update: if isAuthenticated();
      // Users can delete requests they created
      allow delete: if isAuthenticated() && 
                       resource.data.requestedBy == request.auth.uid;
    }
    
    // Player team requests collection
    match /player_team_requests/{requestId} {
      // Users can read requests related to them
      allow read: if isAuthenticated() && (
                     resource.data.playerId == request.auth.uid ||
                     resource.data.requestedBy == request.auth.uid
                   );
      // Authenticated users can create requests
      allow create: if isAuthenticated() && 
                       request.resource.data.createdAt != null;
      // Users can update requests related to them
      allow update: if isAuthenticated() && (
                     resource.data.playerId == request.auth.uid ||
                     resource.data.requestedBy == request.auth.uid
                   );
      // Users can delete requests they created
      allow delete: if isAuthenticated() && 
                       resource.data.requestedBy == request.auth.uid;
    }
    
    // Messages/Chat collection
    match /messages/{messageId} {
      // Users can read messages from teams they belong to
      allow read: if isAuthenticated();
      // Users can create messages
      allow create: if isAuthenticated() && 
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.createdAt != null;
      // Users can only update their own messages
      allow update: if isAuthenticated() && 
                       resource.data.createdBy == request.auth.uid;
      // Users can only delete their own messages
      allow delete: if isAuthenticated() && 
                       resource.data.createdBy == request.auth.uid;
    }
  }
}

